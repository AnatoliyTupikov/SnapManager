<Window x:Class="SnapManager.Views.WPF.DBSettings"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SnapManager.Views.WPF"
        xmlns:helpers ="clr-namespace:SnapManager.Views.WPF.WPFHelpers"
        mc:Ignorable="d"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        Title="DBSettings" Height="500" Width="600" ResizeMode="CanResizeWithGrip" 
        MinHeight="400" MinWidth="580"
        xmlns:muc="clr-namespace:MyUserControls;assembly=MyUserControls" >

    <Window.Resources>

        <SolidColorBrush x:Key="ErrorRed" Color="Crimson" Opacity="0.1"/>
        <SolidColorBrush x:Key="CommonBack" Color =  "LightGray" Opacity="0.2"/>
        
        <DataTemplate x:Key="IntDataTemplate">
            <muc:Spinner SpinnerValueInt="{Binding Path=Column2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         MinValue="1024"
                         MaxValue="65535"
                         HorizontalAlignment="Left"
                         Width="75"
                         MinHeight="30"
                         Height="Auto"/>

        </DataTemplate>       

        <DataTemplate x:Key="StringDataTemplate">
            <TextBox Text="{Binding Path=Column2, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                     HorizontalAlignment="Left"
                     MinWidth="100">
                <TextBox.Style>                    
                    <Style TargetType="TextBox">
                        <Setter Property="Background" Value="{StaticResource CommonBack}"/>
                        <Setter Property="BorderThickness" Value="0.5"/>
                        <Setter Property="Validation.ErrorTemplate" Value="{x:Null}"/>
                        <Setter Property="Validation.ErrorTemplate">
                            <Setter.Value>                                
                                <ControlTemplate>
                                    <DockPanel LastChildFill="True">                                        
                                        <!-- Отображаем сам TextBox -->
                                        <AdornedElementPlaceholder DockPanel.Dock="Left"/>
                                        <Label Foreground="Red" 
                                            DockPanel.Dock="Right"                                           
                                            HorizontalContentAlignment="Center"
                                            VerticalContentAlignment="Center"
                                            Content="⚠"
                                            FontSize="{Binding Path=AdornedElement.FontSize, 
                                                        RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Adorner}}"
                                            ToolTip="{Binding Path=AdornedElement.(Validation.Errors)[0].ErrorContent,
                                                        RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Adorner}}"
                                            ToolTipService.IsEnabled="True" Padding="0,-1,0,0" Margin="10,0,0,0"/>                                        
                                    </DockPanel>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>                            
                            <Trigger Property="Validation.HasError" Value="True">
                                <Setter Property="SelectionBrush" Value="Black"/>
                                <Setter Property="CaretBrush" Value="Black"/>
                                <Setter Property="BorderThickness" Value="0.5"/>
                                <Setter Property="Background" Value="{StaticResource ErrorRed}"/>
                                <Setter Property="BorderBrush" Value="Red"/>
                                <Setter Property = "ToolTip" Value="{Binding RelativeSource={x:Static RelativeSource.Self}, Path=(Validation.Errors)[0].ErrorContent}"/>

                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TextBox.Style>
            </TextBox>


        </DataTemplate>        

        <local:DBSettingsWindowTemplateSelector x:Key="PropSelector"
                                          IntProp="{StaticResource ResourceKey=IntDataTemplate}"
                                          StringProp="{StaticResource ResourceKey=StringDataTemplate}"/>



    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="60"  />
            <RowDefinition Height="*" />
            <RowDefinition Height="20"/>
            <RowDefinition Height="50"  />
        </Grid.RowDefinitions>
        <Label Grid.Row="0" Content="Database settings" Canvas.Left="212" Canvas.Top="10" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
        <Border Grid.Row="1" Margin="25,14,25,10" BorderBrush="Black" BorderThickness="1">
            <Grid  >
                <Grid.RowDefinitions>
                    <RowDefinition Height="45"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>           

                <DataGrid 
                    EnableRowVirtualization="False"
                    EnableColumnVirtualization="False"
                    x:Name="DBConfDataGrid"
                    ItemsSource="{Binding SelectedDbProvider.Value}"
                    CanUserResizeRows="True"                    
                    SelectionUnit="Cell"
                    SelectionMode="Single"
                    CanUserSortColumns="False"
                    CanUserAddRows="False"                   
                    GridLinesVisibility="Horizontal" Grid.Row="1" d:ItemsSource="{d:SampleData ItemCount=3}" BorderBrush="{x:Null}" AutoGenerateColumns="False" HorizontalGridLinesBrush="#FFCCBDBD" >
                    <DataGrid.RowValidationErrorTemplate>
                        <ControlTemplate>
                            <!-- Ничего не выводим — убираем значок валидации -->
                            <AdornedElementPlaceholder />
                        </ControlTemplate>
                    </DataGrid.RowValidationErrorTemplate>
                    <DataGrid.Resources>
                        <Style TargetType="DataGridCell">
                            <Setter Property="Background" Value="White"/>
                            <Setter Property="Foreground" Value="Black"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderBrush" Value="Transparent"/>

                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Resources>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Property name" Binding="{Binding Column1}" IsReadOnly="True" Width="250"/>
                        
                        <DataGridTemplateColumn Header="Property value" IsReadOnly="False"  CanUserResize="True" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ContentControl Content="{Binding}" ContentTemplateSelector="{StaticResource PropSelector}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            
                        </DataGridTemplateColumn>
                        

                    </DataGrid.Columns>


                </DataGrid>
                
                <ComboBox ItemsSource="{Binding ProvidersList}"
                          DisplayMemberPath="Key"                          
                          SelectedValue="{Binding SelectedDbProvider, Mode=TwoWay}"
                          
                    HorizontalAlignment="Left" Margin="42,0,0,0" VerticalAlignment="Center" Width="207"/>
                <Label Content="Type:" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                <Separator Grid.Row="0" VerticalAlignment="Bottom" Background="#FF131212"/>
            </Grid>
        </Border>
        <CheckBox Grid.Row="2" Content="Create Database if it's no exist" Margin="27,0,0,0" VerticalAlignment="Top" IsChecked="{Binding CreateDbIfNotExist, Mode=TwoWay}"/>

        <Button  Content="Connect" HorizontalAlignment="Right"  Grid.Row="3" VerticalAlignment="Top" Height="40" Width="90" Grid.RowSpan="2" Margin="0,0,26,0"  Command="{Binding MakeConnection}" CommandParameter="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Window}}"/>
        <Button Content="Cancel" HorizontalAlignment="Right" Grid.Row="3" VerticalAlignment="Top" Height="40" Width="90" Grid.RowSpan="2" Padding="1,1,1,1" Margin="0,0,127,0" Command="{Binding Cancel}" CommandParameter="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=Window}}"/>
        <TextBox Name="LogBox" HorizontalAlignment="Left" Grid.Row="3" TextWrapping="Wrap" VerticalAlignment="Top" Width="313" Grid.RowSpan="2" Height="40" VerticalScrollBarVisibility="Auto" Margin="26,0,0,0" Text="{Binding Log, Mode=OneWay}"/>



    </Grid>
</Window>
